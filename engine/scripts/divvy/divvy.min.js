(function(t){"use strict";var e;(function(){var t,i,n,s,o,h,r,d,c,a,l,v="ontouchstart"in document,u="row",f="column",m="left",p="top",g="width",y="height",b="vertical",w="horizontal",E="clientX",z="clientY";e=function(e){var i,n,o,h=this;if(this.el=e.el,i=document.createDocumentFragment(),e.columns&&e.rows)throw Error("You can't have top level rows and top level columns - one or the other");e.columns?(this.type=u,n=e.columns):e.rows&&(this.type=f,n=e.rows),this.blocks={},this.subs={},this.min=e.min||10,this.root=new t(this,this,i,"divvy-0",{children:n},0,100,this.type,{top:!0,right:!0,bottom:!0,left:!0}),s(this.root.node,"divvy-root"),this.el.appendChild(i),e.shakeOnResize!==!1&&(o=function(){h._changedSinceLastResize={},h.shake(),a(h,"resize",h._changedSinceLastResize)},window.addEventListener?window.addEventListener("resize",o):window.attachEvent&&window.attachEvent("onresize",o)),this._changed={},this._changedSinceLastResize={},this.shake()},e.prototype={shake:function(){var t=this.el.getBoundingClientRect();return this.bcr={left:t.left,right:t.right,top:t.top,bottom:t.bottom,width:t.right-t.left,height:t.bottom-t.top},this.bcr.width!==this.width||this.bcr.height!==this.height?(this.width=this.bcr.width,this.height=this.bcr.height,this.pixelSize=this[this.type===f?y:g],this.root.shake(),this):void 0},changed:function(){var t=this._changed;return this._changed={},t},getState:function(){var t={};return r(this.root,t),t},setState:function(t){var e,i={};d(this,this.root,t,i);for(e in i)if(i.hasOwnProperty(e)){a(this,"resize",i);break}return this},save:function(t){var e,i;if(localStorage)return e=t?"divvy_"+t:"divvy",i=JSON.stringify(this.getState()),localStorage.setItem(e,i),this},restore:function(t){var e,i;if(localStorage)return e=t?"divvy_"+t:"divvy",i=JSON.parse(localStorage.getItem(e)),i&&this.setState(i),this},on:function(t,e){var i,n=this;return(i=this.subs[t])?i[i.length]=e:this.subs[t]=[e],{cancel:function(){n.off(t,e)}}},off:function(t,e){var i,n;return t?e?(n=this.subs[t])?(i=n.indexOf(e),-1!==i&&(n.splice(i,1),n.length||delete this.subs[t]),this):this:(delete this.subs[t],this):(this.subs={},this)}},a=function(t,e){var i,n,s,o;if(n=t.subs[e]){if(i=Array.prototype.slice.call(arguments,2),i.length){for(s=0,o=n.length;o>s;s+=1)n[s].apply(t,i);return t}for(s=0,o=n.length;o>s;s+=1)n[s].call(t)}},r=function(t,e){var i;if(e[t.id]=[t.start,t.size],t.children)for(i=t.children.length;i--;)r(t.children[i],e)},d=function(t,e,i,n){var s,o,h,r,c;if(c=i[e.id]){if((e.start!==c[0]||e.size!==c[1])&&(t._changed[e.id]=n[e.id]=!0),e.start=c[0],e.size=c[1],e.end=e.start+e.size,e.node.style[e.type===f?m:p]=e.start+"%",e.node.style[e.type===f?g:y]=e.size+"%",e.children){for(r=0,o=e.children.length,s=0;o>s;s+=1)h=e.children[s],d(t,h,i,n,!0),r+=h.size,e.controls[s]&&e.controls[s].setPosition(r);for(s=e.children.length;s--;)d(t,e.children[s],i,n,!0)}e.shake()}},c=function(t,e){return e?(t._cursor=t.el.style.cursor,t.el.style.cursor=e+"-resize",void 0):(t.el.style.cursor=t._cursor,void 0)},t=function(e,n,o,h,r,d,c,a,l){var v,E,z,L,S,P,x,_,k;if(this.start=d,this.size=c,this.end=this.start+this.size,this.type=a,this.divvy=e,this.parent=n,this.edges=l,this.min=r.min||e.min,this.max=r.max,1===r.nodeType&&(r={node:r}),"string"==typeof r&&(r={id:r}),"[object Array]"===Object.prototype.toString.call(r)&&(r={children:r}),this.id=r.id||h,r.children&&r.children.length?(this.node=document.createElement("div"),s(this.node,"divvy-block"),s(this.node,"divvy-branch"),this.node.id=this.id):(this.node=document.createElement("div"),s(this.node,"divvy-block"),s(this.node,"divvy-leaf"),!r.node&&r.id&&(P=document.getElementById(r.id))&&(r.node=P),this.inner=r.node?r.node:document.createElement("div"),s(this.inner,"divvy-inner"),this.node.appendChild(this.inner),e.blocks[this.id]=this.inner,this.inner.id=this.id),l.top&&s(this.node,"divvy-top"),l.right&&s(this.node,"divvy-right"),l.bottom&&s(this.node,"divvy-bottom"),l.left&&s(this.node,"divvy-left"),this.node.style[a===f?m:p]=d+"%",this.node.style[a===f?g:y]=c+"%",r.children){for(v=0,E=r.children.length;E--;)v+=r.children[E].size||1;for(this.children=[],this.controls=[],z=0,E=0;r.children.length>E;E+=1)L=r.children[E],S=100*((L.size||1)/v),k={},a===f?(k.top=l.top&&0===E,k.bottom=l.bottom&&E===r.children.length-1,k.left=l.left,k.right=l.right):(k.left=l.left&&0===E,k.right=l.right&&E===r.children.length-1,k.top=l.top,k.bottom=l.bottom),this.children[E]=new t(e,this,this.node,h+E,L,z,S,a===f?u:f,k),z+=S;for(E=0;r.children.length-1>E;E+=1)x=this.children[E],_=this.children[E+1],this.controls[E]=new i(e,this,this.node,x,_,a===u?b:w)}o.appendChild(this.node)},t.prototype={setStart:function(t){var e,i,n,s;e=this.start,i=this.size,n=t-e,s=i-n,this.node.style[this.type===f?m:p]=t+"%",this.node.style[this.type===f?g:y]=s+"%",this.start=t,this.size=s,this.shake()},setEnd:function(t){var e,i,n,s;e=this.end,i=this.size,n=t-e,s=i+n,this.node.style[this.type===f?g:y]=s+"%",this.end=t,this.size=s,this.shake()},shake:function(){var t,e,i,n,s,o,h;if(h=this.node.getBoundingClientRect(),this.bcr={left:h.left,right:h.right,top:h.top,bottom:h.bottom,width:h.right-h.left,height:h.bottom-h.top},(this.bcr.width!==this.width||this.bcr.height!==this.height)&&(this.width=this.bcr.width,this.height=this.bcr.height,this.divvy._changed[this.id]=this.divvy._changedSinceLastResize[this.id]=!0,this.children)){for(this.pixelSize=this.bcr[this.type===f?y:g],e=this.children.length,t=0;e-1>t;t+=1)i=this.children[t],n=this.children[t+1],s=this.controls[t],o=i.minPc(),o>i.size&&(i.setEnd(i.start+o),n.setStart(i.start+o),s.setPosition(i.start+o)),o=i.maxPc(),i.size>o&&(i.setEnd(i.start+o),n.setStart(i.start+o),s.setPosition(i.start+o));for(t=e-1;t>0;t-=1)i=this.children[t-1],n=this.children[t],s=this.controls[t-1],o=n.minPc(),o>n.size&&(i.setEnd(n.end-o),n.setStart(n.end-o),s.setPosition(n.end-o)),o=n.maxPc(),n.size>o&&(i.setEnd(n.end-o),n.setStart(n.end-o),s.setPosition(n.end-o));for(t=this.children.length;t--;)this.children[t].shake()}},minPc:function(){var t;return t=this.parent.pixelSize,100*(this.min/t)},maxPc:function(){var t;return this.max?(t=this.parent.pixelSize,100*(this.max/t)):100}},i=function(t,e,i,n,o,h){var r,d=this;this.divvy=t,this.parent=e,this.before=n,this.after=o,this.type=h,this.parentNode=i,this.node=document.createElement("div"),s(this.node,"divvy-"+h+"-control"),v&&s(this.node,"divvy-touch-control"),this.setPosition(o.start),r=function(t){var e,i,s,r,c;t.preventDefault&&t.preventDefault(),e=Math.max(n.start+n.minPc(),o.end-o.maxPc()),i=Math.min(n.start+n.maxPc(),o.end-o.minPc()),s=function(t){var s;s=d.getPosition(t[h===b?E:z]),s=Math.max(e,Math.min(i,s)),n.setEnd(s),o.setStart(s),d.setPosition(s),a(d.divvy,"resize",d.divvy._changedSinceLastResize),d.divvy._changedSinceLastResize={}},r=function(){d.setInactive(),c()},c=function(){document.removeEventListener?(document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",r)):document.detachEvent&&(document.detachEvent("onmousemove",s),document.detachEvent("onmouseup",r))},document.addEventListener?(document.addEventListener("mousemove",s),document.addEventListener("mouseup",r)):document.attachEvent&&(document.attachEvent("onmousemove",s=l(s)),document.attachEvent("onmouseup",r))},this.node.addEventListener?this.node.addEventListener("mousedown",r):this.node.attachEvent&&this.node.attachEvent("onmousedown",r),v&&this.node.addEventListener("touchstart",function(t){var e,i,s,r,c,l,v;1===t.touches.length&&(t.preventDefault(),e=t.touches[0],i=e.identifier,d.setActive(),s=Math.max(n.start+n.minPc(),o.end-o.maxPc()),r=Math.min(n.start+n.maxPc(),o.end-o.minPc()),c=function(t){var e,c;(1!==t.touches.length||t.touches[0].identifier!==i)&&v(),c=t.touches[0],e=d.getPosition(c[h===b?E:z]),e=Math.max(s,Math.min(r,e)),n.setEnd(e),o.setStart(e),d.setPosition(e),a(d.divvy,"resize",d.divvy._changedSinceLastResize),d.divvy._changedSinceLastResize={}},l=function(){d.setInactive(),v()},v=function(){window.removeEventListener("touchmove",c),window.removeEventListener("touchend",l),window.removeEventListener("touchcancel",l)},window.addEventListener("touchmove",c),window.addEventListener("touchend",l),window.addEventListener("touchcancel",l))}),i.appendChild(this.node)},i.prototype={setActive:function(){s(this.node,"divvy-active"),c(this.divvy,this.type===b?"ew":"ns")},setInactive:function(){o(this.node,"divvy-active"),c(this.divvy,!1)},getPosition:function(t){var e,i,n,s;return e=this.parent.bcr,i=e[this.type===b?m:p],n=e[this.type===b?g:y],s=100*(t-i)/n},setPosition:function(t){this.node.style[this.type===b?m:p]=t+"%",this.pos=t}},n=function(t,e){var i,n;for(i=0,n=e.length;n>i;i+=1)if(e[i]===t)return t;return-1},h=function(t){return t.replace(/^\s*/,"").replace(/\s*$/,"")},s=function(t,e){s=t.classList&&t.classList.add?function(t,e){t.classList.add(e)}:function(t,e){var i,s,o;for(i=(t.getAttribute("class")||"").split(" "),o=i.length;o--;)i[o]=h(i[o]);s=i.indexOf?i.indexOf(e):n(e,i),-1===s&&t.setAttribute("class",i.concat(e).join(" "))},s(t,e)},o=function(t,e){o=t.classList&&t.classList.remove?function(t,e){t.classList.remove(e)}:function(t,e){var i,s,o;for(i=(t.getAttribute("class")||"").split(" "),o=i.length;o--;)i[o]=h(i[o]);s=i.indexOf?i.indexOf(e):n(e,i),-1!==s&&(i.splice(s,1),t.setAttribute("class",i.join(" ")))},o(t,e)},l=function(t,e){var i,n;return e=e||500,i=function(){var i;return i=new Date,!n||i-n>e?t.apply(this,arguments):void 0}}})(),"function"==typeof define&&define.amd?define(function(){return e}):"undefined"!=typeof module&&module.exports?module.exports=e:t.Divvy=e})(this);